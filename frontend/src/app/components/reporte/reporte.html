<div class="report-v2">
  <section class="hero-band">
    <div class="hero-left">
      <p class="eyebrow">ANALISIS FINANCIERO</p>
      <h1>Reporte de Facturas</h1>
      <p class="hero-copy">Resumen consolidado de gastos deducibles con desglose de impuesto y vista imprimible.</p>
    </div>
    <div class="hero-actions">
      <button class="btn btn-refresh" (click)="cargarReporte()">
        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
      </button>
      <button class="btn btn-print" (click)="imprimir()">
        <i class="bi bi-printer me-2"></i>Imprimir
      </button>
    </div>
  </section>

  <section *ngIf="errorCarga" class="error-strip">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span>{{ errorCarga }}</span>
  </section>

  <section *ngIf="cargando" class="loading-box">
    <div class="spinner-border text-info" role="status"></div>
    <p>Cargando facturas...</p>
  </section>

  <section *ngIf="!cargando" class="kpi-grid">
    <article class="kpi-card card-a">
      <span class="kpi-label">Registros</span>
      <strong class="kpi-value">{{ gastos.length }}</strong>
      <small>Facturas cargadas</small>
    </article>

    <article class="kpi-card card-b">
      <span class="kpi-label">Total Gastos</span>
      <strong class="kpi-value">${{ calcularTotal().toFixed(2) }}</strong>
      <small>Suma de montos base</small>
    </article>

    <article class="kpi-card card-c">
      <span class="kpi-label">Impuesto Total</span>
      <strong class="kpi-value">${{ calcularImpuestoTotal().toFixed(2) }}</strong>
      <small>Con impuesto calculado</small>
    </article>

    <article class="kpi-card card-d">
      <span class="kpi-label">Promedio</span>
      <strong class="kpi-value">${{ calcularPromedio().toFixed(2) }}</strong>
      <small>Promedio por factura</small>
    </article>
  </section>

  <section *ngIf="!cargando" class="table-shell">
    <div class="table-header">
      <h2>Detalle de comprobantes</h2>
      <span class="pill">Usuario: {{ auth.getUser()?.username || 'sesion' }}</span>
    </div>

    <div class="table-responsive">
      <table class="table report-table mb-0 align-middle">
        <thead>
          <tr>
            <th>RUC Emisor</th>
            <th>Categoria</th>
            <th class="text-end">Monto Base</th>
            <th class="text-end">Impuesto</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let g of gastos">
            <td class="mono">{{ g.ruc }}</td>
            <td>
              <span class="chip" [ngClass]="obtenerColorTipo(g.tipoGasto)">{{ g.tipoGasto }}</span>
            </td>
            <td class="text-end">${{ g.valor.toFixed(2) }}</td>
            <td class="text-end">${{ (g.impuestoCalculado || (g.valor * 0.12)).toFixed(2) }}</td>
            <td class="text-end total-cell">${{ (g.valor + (g.impuestoCalculado || (g.valor * 0.12))).toFixed(2) }}</td>
          </tr>
          <tr *ngIf="gastos.length === 0">
            <td colspan="5" class="empty-state">
              <i class="bi bi-receipt-cutoff"></i>
              <p>No hay facturas para mostrar.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>
